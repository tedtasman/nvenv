#!/usr/bin/env bash

# -----------------------------
# Detect if sourced
# -----------------------------

is_sourced() {
  if [[ -n "${ZSH_VERSION:-}" ]]; then
    # In zsh, when sourced, ZSH_EVAL_CONTEXT is not "toplevel"
    [[ "${ZSH_EVAL_CONTEXT}" != "toplevel" ]]
  elif [[ -n "${BASH_VERSION:-}" ]]; then
    # In bash, check if BASH_SOURCE differs from the script name
    [[ "${BASH_SOURCE[0]}" != "$0" ]]
  else
    return 1
  fi
}

NAME="venv"
UPDATE=false
ACTIVATE=true
CREATED=false
ACTIVATED=false
REQUIREMENTS=false
DELETE=false
EXIT=-1

POSITIONAL_ARGS=()
VENV_FLAGS=()

# -----------------------------
# Utility Functions
# -----------------------------

print_error() {
  echo -e "\033[1;31m$1\033[0m"
}

print_warning() {
  echo -e "\033[1;33m$1\033[0m"
}

print_help() {
  cat <<EOF
Usage: source nvenv [options] [-- venv-flags]

Options:
  -n, --name NAME         Virtual environment name (default: venv)
  -u, --upgrade           Upgrade pip in the environment
  -s, --skip-activate     Do not activate after creation
  -r, --requirements      Install ./requirements.txt in the virtual environment
  -d, --delete            Delete the virtual environment with name NAME
  -h, --help              Show this help message

Venv flags (passed to python -m venv):
  Any flags after -a or --args are passed directly to python -m venv

Examples:
  source nvenv
  source nvenv -n .venv
  source nvenv --update
  source nvenv -n env -s
  source nvenv -- --system-site-packages
  source nvenv -n .venv -- --system-site-packages
EOF
}

prompt_yes() {
  local message="$1"
  local response

  if [[ "$INTERACTIVE" == false ]]; then
    return 0
  fi

  if [[ -n "${ZSH_VERSION:-}" ]]; then
    read -r "?$message [y/N] " response </dev/tty
  else
    read -r -p "$message [y/N] " response </dev/tty
  fi

  case "$response" in
    [yY]|[yY][eE][sS])
      return 0
      ;;
    *)
      return 1
      ;;
  esac
}

# -----------------------------
# Detect Python
# -----------------------------

if command -v python3 >/dev/null 2>&1; then
  PYTHON_BIN="python3"
elif command -v python >/dev/null 2>&1; then
  PYTHON_BIN="python"
else
  print_error "Python not found in PATH"
  EXIT=0
fi

# -----------------------------
# Argument Parsing
# -----------------------------

while [[ $# -gt 0 && $EXIT == -1 ]]; do
  case "$1" in
    -n|--name)
      if [[ -z "${2:-}" ]]; then
        print_error "--name requires a value"
        EXIT=1
      fi
      NAME="$2"
      shift 2
      ;;
    -u|--upgrade)
      UPDATE=true
      shift
      ;;
    -s|--skip-activate)
      ACTIVATE=false
      shift
      ;;
    -r|--requirements)
      REQUIREMENTS=true
      shift
      ;;
    -d|--delete)
      DELETE=true
      shift
      ;;
    -h|--help)
      print_help
      EXIT=0
      ;;
    -a|--args)
      shift
      VENV_FLAGS+=("$@")
      break
      ;;
    -*)
      # Pass through unknown flags to venv
      VENV_FLAGS+=("$1")
      shift
      ;;
    *)
      POSITIONAL_ARGS+=("$1")
      shift
      ;;
  esac
done

set -- "${POSITIONAL_ARGS[@]}"

# -----------------------------
# Removal
# -----------------------------

if [[ $DELETE == true && $EXIT == -1 ]]; then
  if [[ -d "$NAME" ]]; then
    if prompt_yes "Delete virtual environment '$NAME'?"; then
      rm -rf "$NAME"/
      echo "'$NAME' deleted"
    else
      echo "Not deleting '$NAME'"
    fi
  fi
  EXIT=1
fi

# -----------------------------
# Create Virtual Environment
# -----------------------------

if [[ ! -d "$NAME" && $EXIT == -1 ]]; then
  "$PYTHON_BIN" -m venv "${VENV_FLAGS[@]}" "$NAME"
  CREATED=true
  echo "Virtual environment '$NAME' created"

elif [[ "$UPDATE" == false && "$ACTIVATE" == false && EXIT == -1 ]]; then
  print_error "Virtual environment '$NAME' already exists"
  EXIT=1
fi

# -----------------------------
# Update pip if requested
# -----------------------------

if [[ "$UPDATE" == true && $EXIT == -1 ]]; then
  echo ""
  echo "Updating pip..."
  "$NAME/bin/python" -m pip install --upgrade pip
  echo "Virtual environment '$NAME' updated"
  echo ""
fi

# -----------------------------
# Install requirements if requested
# -----------------------------

if [[ "$REQUIREMENTS" == true && -f "requirements.txt" && EXIT == -1 ]]; then
  echo "Installing requirements..."
  "$NAME/bin/pip" install -r requirements.txt
  echo "Installed requirements"
  echo ""
fi

# -----------------------------
# Activate if requested
# -----------------------------

if [[ "$ACTIVATE" == true && $EXIT == -1 ]]; then
  if is_sourced; then
    # shellcheck disable=SC1090
    source "$NAME/bin/activate"
    ACTIVATED=true
  else
    print_warning "Run with: source ./nvenv to activate"
  fi
fi

if [[ is_sourced == 0 ]]; then
  exit $EXIT
fi